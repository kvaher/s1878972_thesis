---
title: "Relative abundance: plots and stats"
author: 
  - "Kadi Vaher"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=F, message=F}

library(tidyverse) 
library(here) 
library(phyloseq)
library(decontam)
library(RColorBrewer)
library(knitr)
library(ggpubr)
library(vegan)
library(ggrepel)
library(Maaslin2)

# set paths
knitr::opts_knit$set(root.dir=".", aliases=c(h = "fig.height", w = "fig.width", ow = "out.width"))
knitr::opts_chunk$set(dev = c('png'), 
                      fig.path = here("results", "figures", "16S_relative_abundance", ""), dpi = 300)
theme_set(theme_light()) # global option for ggplot2
```

# Run the whole document - ONLY AT THE END OF THE WORKSTREAM

```{r knit, echo=F, eval=FALSE}
rmarkdown::render(input = here("scripts", "16S_relative_abundance.Rmd"), output_dir = here("results", "reports"))
```

# Load functions

Here load some custom functions which support the analysis below. The scripts for these functions can be found in the `src/`-folder.
The load_dada is for creating the ASV names, filtering out 'Mitochondria', 'Chloroplast', 'Archae' or 'Eukaryota'

```{r}
source(here("src", "load_dada.R"))
source(here("src", "utils_kadi.R"))

```

# Load files

```{r, message = F}
# load phyloseq object from qc and decontam process
phy <- readRDS(here("processed_data", "qc_decontam", "ps_final.Rds"))
phy_RA <- readRDS(here("processed_data", "qc_decontam", "ps_final_RA.Rds"))

```

# Doublecheck if correct files
This file should have 174 ASVs

```{r checking_objects}

ntaxa(phy)
ntaxa(phy_RA)

```

# Do a descriptive RA bar plot for the three different sample types
Simply for visualisation

``` {r final_RA_bar, ow = "50%"}

sample_barplot <- stacked.bar(phy, hc_order=F, n_otus=25) +
  facet_grid(~type_timepoint, scales = "free_x", space="free", labeller = as_labeller(c("0_V1" = "Term\nmeconium", "1_V1" = "Preterm\nmeconium", "1_V2" = "Preterm\npre-discharge")))+ 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), strip.text = element_text(size=12, color="black"), strip.background = element_rect(
     color="black", fill="white", size=1, linetype="solid"
     ), axis.title=element_text(size=12), axis.text=element_text(size=11), legend.title = element_text(size = 12)) 

sample_barplot

png(file=here("results", "figures", "sample_barplot_figure.png"), width = 30, height =10 , units = "in",res=300)
print(sample_barplot)
dev.off()


```


```{r timepoint_RA_plots, ow = "50%"}

# calculate mean abundance on phylum level per time point
phy_phylum <- tax_glom(phy, taxrank = "phylum")
taxa_names(phy_phylum) <- tax_table(phy_phylum)[,"phylum"]
sample_data(phy_phylum) <- sample_data(phy_phylum)[, 
  sapply(sample_data(phy_phylum), class) == "numeric" | colnames(sample_data(phy_phylum)) == "type_timepoint"] # include only numeric variables and "time" (= group-variable)

phy_phylum %>%
  merge_samples(group = "type_timepoint", fun=mean) %>% # mean number of reads per phylum/group
  transform_sample_counts(., function(x) 100 * x/sum(x)) %>%
  otu_table


# calculate mean abundance on genus level per time point
phy_genus <- tax_glom(phy, taxrank = "genus")
taxa_names(phy_genus) <- tax_table(phy_genus)[,"genus"]
sample_data(phy_genus) <- sample_data(phy_genus)[, 
  sapply(sample_data(phy_genus), class) == "numeric" | colnames(sample_data(phy_genus)) == "type_timepoint"] # include only numeric variables and "time" (= group-variable)

phy_genus %>%
  merge_samples(group = "type_timepoint", fun=mean) %>% # mean number of reads per genus/group
  transform_sample_counts(., function(x) 100 * x/sum(x)) %>%
  otu_table

```

## Group-wise barplots
Also only for visualisation

``` {r group_barplots, ow = "50%"}

# Abundance plots for top 25 OTUs
#using the function I created when doing the clustering (in utils_kadi file)
grouped_asv_plot <- grouped_stacked_bar(phy, n_otus = 25, grouping_var = "type_timepoint") +
  scale_x_discrete(labels=c("X0_V1" = "Term\nmeconium", "X1_V1" = "Preterm\nmeconium",
                              "X1_V2" = "Preterm\npre-discharge"))

grouped_asv_plot

png(file=here("results", "figures", "groupwise_asv_barplot.png"), width = 8.7, height = 6, units = "in",res=300)
print(grouped_asv_plot)
dev.off()


```

# Barplots on genus level: both for group-wise as well as for individual samples
This below chunk is based on a script from Wouter from the niches paper; again for visualisation

``` {r group_barplots_genus, ow = "50%"}

n_genus <- 20

ps_genus <- tax_glom(phy, taxrank = "genus")

otu_genus <- left_join(
  ps_genus %>%
    tax_table() %>%
    as.data.frame() %>%
    select(-ASV) %>%
    rownames_to_column("ASV"),
  ps_genus %>%
    otu_table() %>%
    as.data.frame() %>%
    rownames_to_column("ASV"), by = "ASV")

otu_genus_sum <- otu_genus %>%
  group_by(genus) %>%
  summarise(across(-c(ASV:species), sum)) %>%
  column_to_rownames("genus")

otu_genus_n <- otu_genus_sum[order(rowMeans(otu_genus_sum), decreasing = TRUE)[1:n_genus], ]
otu_genus_res <- otu_genus_sum[-order(rowMeans(otu_genus_sum), decreasing = TRUE)[1:n_genus], ]

otu_genus_n <- otu_genus_n %>%
  t %>%
  data.frame(Residuals = colSums(otu_genus_res), check.names = FALSE) %>%
  t

genus_prep <- t(t(otu_genus_n)/colSums(otu_genus_n)) %>% # to RA
  as.data.frame() %>%
  rownames_to_column("genus") %>%
  pivot_longer(-genus, names_to = "sample_id", values_to = "RA") %>%
  left_join(phy %>% meta_to_df(), by = "sample_id")

genus_phyl <- ps_genus %>%
  tax_table() %>%
  as.data.frame() %>%
  filter(genus %in% rownames(otu_genus_n)) %>%
  select(genus, phylum)

genus_prep_order <- genus_prep %>% 
  left_join(genus_phyl, by = "genus") %>% 
  group_by(phylum, genus) %>%
  summarise(mean_RA_genus = mean(RA)) %>%
  group_by(phylum) %>%
  mutate(mean_RA_phyl = sum(mean_RA_genus)) %>%
  ungroup() %>%
  arrange(desc(mean_RA_phyl), desc(mean_RA_genus)) %>%
  mutate(genus = fct_inorder(genus) %>% fct_relevel(., "Residuals", after = Inf))

genus_prep_order2 <- genus_prep %>% 
  left_join(genus_phyl, by = "genus") %>% 
  group_by(genus) %>%
  summarise(mean_RA_genus = mean(RA)) %>% 
  ungroup() %>%
  arrange(desc(mean_RA_genus)) %>%
  mutate(genus = fct_inorder(genus) %>% fct_relevel(., "Residuals", after = Inf))

#make colour scheme
cols_genus2 <- c(make_color_scheme("Paired", n_genus), "grey90")
names(cols_genus2) <- levels(genus_prep_order2$genus)
                 
groupwise_genus_plot <- genus_prep %>%
    mutate(genus = fct_relevel(genus, rev(levels(genus_prep_order2$genus)))) %>%
    group_by(genus, type_timepoint) %>%
    summarise(mean_RA = mean(RA)) %>%
    ggplot(aes(x = type_timepoint, y = mean_RA, fill = genus)) +
      geom_bar(stat="identity", color = "white", width = 0.8, position = position_stack()) +
      scale_fill_manual(name = "Genus", values = cols_genus2, guide = guide_legend(ncol = 2, reverse = F)) +
      scale_y_continuous(labels = scales::percent, breaks = scales::pretty_breaks(n = 5), expand = expansion(mult = 0)) +
      labs(x = "", y = "Mean relative abundance (%)") +
  scale_x_discrete(labels=c("0_V1" = "Term\nmeconium", "1_V1" = "Preterm\nmeconium",
                              "1_V2" = "Preterm\npre-discharge")) + 
  theme_bw(base_size = 13) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line.x = element_line(color = "grey80"),
        axis.line.y = element_line(color = "grey80"), 
        #axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right",
        #legend.direction = "horizontal",
        #legend.text = element_text(size = 10),
        #legend.title = element_blank(),
        #legend.key.width = unit(0.4, "cm"),
        #legend.key.height = unit(0.3, "cm"),
        axis.title.x = element_blank(), legend.text = ggtext::element_markdown(face="italic"),
        legend.key.width=unit(0.6,"cm"))

groupwise_genus_plot

png(file=here("results", "figures", "groupwise_genus_barplot.png"), width = 8.7, height = 6, units = "in",res=300)
print(groupwise_genus_plot)
dev.off()


#also plot top genera per sample
sample_genus_plot <- genus_prep %>%
    mutate(genus = fct_relevel(genus, rev(levels(genus_prep_order2$genus)))) %>%
    group_by(genus, sample_id2, type_timepoint) %>%
    summarise(mean_RA = mean(RA)) %>%
    ggplot(aes(x = sample_id2, y = mean_RA, fill = genus)) +
      geom_col() +
      scale_fill_manual(name = "Genus", values = cols_genus2, guide = guide_legend(ncol = 2, reverse = F)) +
      scale_y_continuous(labels = scales::percent, breaks = scales::pretty_breaks(n = 5), expand = expansion(mult = 0)) +
      facet_grid(~type_timepoint, space="free", scales = "free_x", labeller = as_labeller(c("0_V1" = "Term\nmeconium", "1_V1" = "Preterm\nmeconium", "1_V2" = "Preterm\npre-discharge"))) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), strip.text = element_text(size=12, color="black"), , strip.background = element_rect(
     color="black", fill="white", size=1, linetype="solid"
     ), axis.title=element_text(size=12), axis.text=element_text(size=11), legend.title = element_text(size = 12),
        legend.text = ggtext::element_markdown(face="italic")) +
      labs(x = "", y = "Relative abundance (%)")

sample_genus_plot

png(file=here("results", "figures", "sample_genus_barplot_samewidth.png"), width = 30, height =10, units = "in",res=300)
print(sample_genus_plot)
dev.off()


```

# Metadata
Read in metadata to run different maaslin2 models

```{r metadata}

all_samples_demo <- read.csv(here("processed_data", "demographics_microbiome_samples_250_01092022.csv"), header=T)

qc_demo <- read.csv(here("processed_data", "metadata_qc_decontam_23082022.csv"), header=T)
qc_demo <- qc_demo %>% subset(sample_type=="sample") %>% select(-record_id, -Time_point, -Visit_number, -preterm, -GA_birth, -postnatal_age_at_sample_d, -PMA_sample_w, -cos_excluded_options)

demo <- merge(qc_demo, all_samples_demo, by="sample_id", all.x=T)

demo <- demo %>% subset(sample_work_nr %in% rownames(sample_data(phy)))


rownames(demo) <- demo$sample_work_nr

#match the order of demo data with that in the phyloseq object
demo=demo[match(rownames(sample_data(phy)),rownames(demo)),]
all(rownames(demo)==rownames(sample_data(phy)))


#also merge the demodata with the phyloseq object
demo_sampledata <- sample_data(demo)
phy <- merge_phyloseq(phy, demo_sampledata)

```

#Maaslin2
Run Maaslin2 to test associations between microbiota taxa relative abundances and perinatal factors
First need to convert the taxa table to relative abundances or use CLR normalisation
Then filter to have top X taxa to be tested
And finally can run maaslin: https://github.com/biobakery/biobakery/wiki/maaslin2#32-running-maaslin2

For CLR normalisations: https://cran.r-project.org/web/packages/compositions/index.html

Maaslin2 I will run with the following parameters:
- default transformation (log)
- filtering: ASVs present with at least 1% of abundance in at least 5% of samples

The below are models presented in the thesis


## Preterm infant samples: testing for the effect sample type

```{r maaslin_sampletype, ow = "50%"}

#subset to preterm infant samples
phy_preterm <- phy %>% subset_samples((preterm==1))

#now do TSS normalisation (calculate relative abundances)
phy_preterm_RA <- phy_preterm %>% to_RA

#prepare input for maaslin
preterm_asv <- t(data.frame(otu_table(phy_preterm_RA)))
preterm_meta <- sample_data(phy_preterm_RA) %>% data.frame()
  
all(rownames(preterm_meta)==rownames(preterm_asv))

preterm_meta$record_id <- as.factor(preterm_meta$record_id)

#run maaslin - putting in record_id as the random effect caused singularity issues
maaslin_preterms_norandom = Maaslin2(
    input_data = preterm_asv, 
    input_metadata = preterm_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_preterms_sampletype_norandom"), 
    fixed_effects = c("Visit_number"))


#visualise
maaslin_preterms_norandom_bar= as.data.frame(maaslin_preterms_norandom$results)%>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Preterm meconium","Preterm pre-discharge"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
  geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#FDC46B", "#7570B3"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-6.5,6.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("")

maaslin_preterms_norandom_bar

#how many participants have two samples -> 26 only
dim(preterm_meta[duplicated(preterm_meta$record_id),])[1]

```

When running the model with the random effect of subject, I get a warning message about singularity. This is probably because the model is too complex for the data. When removing the random effects, the warnings/errors disappear. Thought: it could be because most record_id's are in one or the other timepoint and there are only a small number of participants with matching data.

## Meconium samples: testing for the effect of preterm birth 

```{r maaslin_meconium, ow = "50%"}

#subset to meconium samples
phy_mec <- phy %>% subset_samples((Visit_number=="V1"))

#now do TSS normalisation (calculate relative abundances)
phy_mec_RA <- phy_mec %>% to_RA

#prepare input for maaslin
mec_asv <- t(data.frame(otu_table(phy_mec_RA)))
mec_meta <- sample_data(phy_mec_RA) %>% data.frame()
all(rownames(mec_meta)==rownames(mec_asv))
mec_meta$preterm <- as.factor(mec_meta$preterm)
mec_meta <- mec_meta %>% mutate(preterm_factor = ifelse(preterm==0, "term", "preterm"))
mec_meta$preterm_factor = as.factor(mec_meta$preterm_factor)

#run maaslin for term vs preterm meconium sample, adding postnatal day as a confounder
maaslin_mec_adjpostnatalday = Maaslin2(
    input_data = mec_asv, 
    input_metadata = mec_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_mec_termpreterm_adjpostnatalday"), 
    fixed_effects = c("preterm_factor", "postnatal_age_at_sample_d"),
    reference = c("preterm_factor,term"))

maaslin_mec_adjpostnatalday_bar= as.data.frame(maaslin_mec_adjpostnatalday$results)%>%
  subset(metadata=="preterm_factor") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Preterm meconium", "Term meconium"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
              geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#FDC46B", "#1B9E77"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-6.5,6.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") #+ ggtitle("Effect of preterm birth, adjusted for postnatal age at sample collection")

maaslin_mec_adjpostnatalday_bar

```

Make a joint figure for sample type maaslin

```{r fig_sampletype_maaslin, ow = "50%"}

sample_type_joint <- ggarrange(maaslin_mec_adjpostnatalday_bar, maaslin_preterms_norandom_bar, nrow=2, align="v", heights=c(1.2,4), labels = c("A", "B"))

sample_type_joint

png(file=here("results", "figures", "sampletype_maaslin.png"), width = 10, height =8, units = "in",res=300)
print(sample_type_joint)
dev.off()

```


## Preterm meconium samples
associations with 
- mode of delivery
- birthweight z-score

```{r maaslin_preterm_meconium, ow = "50%"}

#subset to meconium samples
phy_prem_mec <- phy %>% subset_samples((preterm == 1 & Visit_number=="V1"))

#now do TSS normalisation (calculate relative abundances)
phy_prem_mec_RA <- phy_prem_mec %>% to_RA

#prepare input for maaslin
prem_mec_asv <- t(data.frame(otu_table(phy_prem_mec_RA)))
prem_mec_meta <- sample_data(phy_prem_mec) %>% data.frame()

all(rownames(prem_mec_meta)==rownames(prem_mec_asv))

#############################
#mode of delivery, adjusted for postnatal age at sample
maaslin_prem_mec_modedelivery_adjpostnatal = Maaslin2(
    input_data = mec_asv, 
    input_metadata = prem_mec_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_prem_mec_modedelivery_adjpostnatal"), 
    fixed_effects = c("Vaginal_delivery", "postnatal_age_at_sample_d"))

#visualise
maaslin_prem_mec_modedelivery_adjpostnatal_bar= as.data.frame(maaslin_prem_mec_modedelivery_adjpostnatal$results)%>%
              subset(metadata=="Vaginal_delivery") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "C-section", "Vaginal delivery"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
  geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#036268", "#9BC6A7"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Mode of delivery, adjusted for postnatal age at sample")

maaslin_prem_mec_modedelivery_adjpostnatal_bar

#do vaginal vs c-section born babies pass their mec at different time?
kable(prem_mec_meta %>% group_by(Vaginal_delivery) %>% summarise(mean_postnatal_age = mean(postnatal_age_at_sample_d)))
t.test(prem_mec_meta$postnatal_age_at_sample_d~prem_mec_meta$Vaginal_delivery)
#slightly but not statistically significantly

#additionally adjust for birthweight z-score
maaslin_prem_mec_modedelivery_adjpostnatal_bwz = Maaslin2(
    input_data = mec_asv, 
    input_metadata = prem_mec_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_prem_mec_modedelivery_adjpostnatal_bwz"), 
    fixed_effects = c("Vaginal_delivery", "postnatal_age_at_sample_d", "birthweight_z_score"))

maaslin_prem_mec_modedelivery_adjpostnatal_bwz_bar= as.data.frame(maaslin_prem_mec_modedelivery_adjpostnatal_bwz$results)%>%
              subset(metadata=="Vaginal_delivery") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "C-section", "Vaginal delivery"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
  geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#036268", "#9BC6A7"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Mode of delivery, adjusted for postnatal age at sample and birthweight z-score")

maaslin_prem_mec_modedelivery_adjpostnatal_bwz_bar

kable(as.data.frame(maaslin_prem_mec_modedelivery_adjpostnatal_bwz$results%>%
              subset(metadata=="Vaginal_delivery") %>%
               arrange(coef)))

#when additionally adjusting for birthweight z-score then the only significant effect is that C-section babies have more staphylococcus

#effect of bw z-score -> no significant ASVs
kable(maaslin_prem_mec_modedelivery_adjpostnatal_bwz$results%>%subset(metadata=="birthweight_z_score") %>%arrange(coef))


############################
#effect of BW z-score, only adjusted for postnatal age at sample collection
maaslin_prem_mec_bwz_adjpostnatal = Maaslin2(
    input_data = mec_asv, 
    input_metadata = prem_mec_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_prem_mec_bwz_adjpostnatal"), 
    fixed_effects = c("birthweight_z_score", "postnatal_age_at_sample_d"))

maaslin_prem_mec_bwz_adjpostnatal_bar= as.data.frame(maaslin_prem_mec_bwz_adjpostnatal$results)%>%
              subset(metadata=="birthweight_z_score") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "negative correlation with\nbirthweight z-score", "positive correlation with\nbirthweight z-score"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
  geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#34487A", "#CF5A47"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Birthweight z-score, adjusted for postnatal age at sample")

maaslin_prem_mec_bwz_adjpostnatal_bar


#make joined plot for the variables tested for meconium samples
mec_joint <- ggarrange(maaslin_prem_mec_modedelivery_adjpostnatal_bar, maaslin_prem_mec_modedelivery_adjpostnatal_bwz_bar, maaslin_prem_mec_bwz_adjpostnatal_bar, nrow=3, align="v", labels = c("A", "B", "C"), heights=c(2.5,0.92,0.92))

mec_joint

png(file=here("results", "figures", "perinatal_mec_maaslin.png"), width = 11.1, height =7, units = "in",res=300)
print(mec_joint)
dev.off()

#is BW z-score different in vaginally vs c-section born infants
t.test(birthweight_z_score~Vaginal_delivery, data=prem_mec_meta)
prem_mec_meta %>%
  ggplot(aes(x=as.factor(Vaginal_delivery), y=birthweight_z_score, color=as.factor(Vaginal_delivery))) +
  geom_boxplot(outlier.colour = NA) +
  geom_jitter(width = 0.2, size=2.5, alpha=0.6) +
  xlab("") +
  theme_bw(base_size=13)

```


## Discharge samples: testing for association with GA group (very vs extremely preterm infants)

```{r maaslin_discharge, ow = "50%"}

#subset to discharge samples
phy_disch <- phy %>% subset_samples((Visit_number=="V2"))

#now do TSS normalisation (calculate relative abundances)
phy_disch_RA <- phy_disch %>% to_RA

#prepare input for maaslin
disch_asv <- t(data.frame(otu_table(phy_disch_RA)))
disch_meta <- sample_data(phy_disch_RA) %>% data.frame()
all(rownames(disch_meta)==rownames(disch_asv))

#run maaslin for very vs extremely preterm
#filtering: for DA testing only include ASVs present with at least 1% of abundance in at least 5% of samples - but then only tests 21 taxa
#adjusting for PMA at sample
maaslin_disch_GAgroup_adjPMAsample = Maaslin2(
    input_data = disch_asv, 
    input_metadata = disch_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_disch_GAgroup_adjPMAsample"), 
    fixed_effects = c("extremely_preterm", "PMA_sample_w"))


#do a plot
maaslin_disch_GAgroup_adjPMAsample_bar= as.data.frame(maaslin_disch_GAgroup_adjPMAsample$results)%>%
              subset(metadata=="extremely_preterm") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Very preterm", "Extremely preterm"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#DAA9CD", "#874B78"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("GA group")

maaslin_disch_GAgroup_adjPMAsample_bar

png(file=here("results", "figures", "GAgroup_disch_maaslin.png"), width = 11.1, height =5, units = "in",res=300)
print(maaslin_disch_GAgroup_adjPMAsample_bar)
dev.off()

#are samples collected at different GA for very and extremely preterms
t.test(PMA_sample_w ~ extremely_preterm, data=disch_meta)
disch_meta %>%
  ggplot(aes(x=as.factor(extremely_preterm), y=PMA_sample_w, color=as.factor(extremely_preterm))) +
  geom_boxplot(outlier.colour = NA) +
  geom_jitter(width = 0.2, size=2.5, alpha=0.6) +
  xlab("") +
  theme_bw(base_size=13)

#-----------------------------------------------------------
#add other covariates to this model for a fully adjusted model
maaslin_disch_GAgroup_adjPMAsample_sex_abx = Maaslin2(
    input_data = disch_asv, 
    input_metadata = disch_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_disch_GAgroup_adjPMAsample_sex_abx"), 
    fixed_effects = c("extremely_preterm", "PMA_sample_w", "sex", "AB_after72h"))

#display the results
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results %>% subset(metadata=="extremely_preterm") %>% filter(qval<0.25))
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results %>% subset(metadata=="sex"))
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results %>% subset(metadata=="AB_after72h"))

#do plots for each of the variables in the model

#GAgroup
maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results)%>%
              subset(metadata=="extremely_preterm") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Very preterm", "Extremely preterm"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#DAA9CD", "#874B78"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("GA group")

maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar

#sex
maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results)%>%
              subset(metadata=="sex") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Male", "Female"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#5179C3", "#D890B1"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Sex")

maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar

#abx
maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx$results)%>%
              subset(metadata=="AB_after72h") %>%
               arrange(coef)%>%
  mutate(group = if_else(coef<0, "No antibiotics", "Antibiotics >72h"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               filter(qval<0.25) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#E7C382", "#88886A"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Antibiotic exposure >72h")

maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar

#make a joint figure
full_disch <- ggarrange(maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar, maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar, maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar, nrow=3, align="v", heights=c(2.8,2,1.45))

full_disch

png(file=here("results", "figures", "perinatal_full_disch_maaslin.png"), width = 11.1, height =7, units = "in",res=300)
print(full_disch)
dev.off()


```

## Do the full model in babies who didn't have nec or sepsis

```{r maaslin_discharge_nonecsepsis, ow = "50%"}

#subset to discharge samples for infants without nec or sepsis
phy_disch_nonec_sepsis <- phy %>% subset_samples((Visit_number=="V2" & nec_binary==0 & sepsis_binary==0))

#now do TSS normalisation (calculate relative abundances)
phy_disch_RA_nonec_sepsis <- phy_disch_nonec_sepsis %>% to_RA

#prepare input for maaslin
disch_asv_nonec_sepsis <- t(data.frame(otu_table(phy_disch_RA_nonec_sepsis)))
disch_meta_nonec_sepsis <- sample_data(phy_disch_RA_nonec_sepsis) %>% data.frame()
all(rownames(disch_meta_nonec_sepsis)==rownames(disch_asv_nonec_sepsis))

#run Maaslin
maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis = Maaslin2(
    input_data = disch_asv_nonec_sepsis, 
    input_metadata = disch_meta_nonec_sepsis, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis"), 
    fixed_effects = c("extremely_preterm", "PMA_sample_w", "sex", "AB_after72h"))

#display results
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results %>% subset(metadata=="extremely_preterm") %>% filter(qval<0.25))
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results %>% subset(metadata=="sex")) #%>% filter(qval<0.25))
kable(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results %>% subset(metadata=="AB_after72h")%>% filter(qval<0.25))

#make a figure
maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar_nonecsepsis= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results)%>%
              subset(metadata=="extremely_preterm") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Very preterm", "Extremely preterm"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#DAA9CD", "#874B78"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("GA group")

maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar_nonecsepsis

maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar_nonecsepsis= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results)%>%
              subset(metadata=="sex") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Male", "Female"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#5179C3", "#D890B1"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Sex")

maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar_nonecsepsis

maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar_nonecsepsis= as.data.frame(maaslin_disch_GAgroup_adjPMAsample_sex_abx_nonecsepsis$results)%>%
              subset(metadata=="AB_after72h") %>%
               arrange(coef)%>%
  mutate(group = if_else(coef<0, "No antibiotics", "Antibiotics >72h"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               filter(qval<0.25) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#E7C382", "#88886A"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Antibiotic exposure >72h")

maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar_nonecsepsis

#make a joint figure
full_disch_nonecsepsis <- ggarrange(maaslin_disch_GAgroup_adjPMAsample_sex_abx_bar_nonecsepsis, maaslin_disch_sex_adjGAgroup_PMAsample_abx_bar_nonecsepsis, maaslin_disch_lateabx_adjGAbirth_PMAsample_sex_bar_nonecsepsis, nrow=3, align="v", heights=c(3.1,2,1.45))

full_disch_nonecsepsis

png(file=here("results", "figures", "perinatal_full_disch_maaslin_nonecsepsis.png"), width = 11.1, height =7, units = "in",res=300)
print(full_disch_nonecsepsis)
dev.off()


```

## Discharge samples: testing for association with other factors - baseline, adjusted for GAgroup and PMA at sample collection
- antibiotic exposure
- sex

```{r maaslin_discharge_otherfactors, ow = "50%"}

#effect of late abx exposure
maaslin_disch_lateabx_adjGAgroup_PMAsample = Maaslin2(
    input_data = disch_asv, 
    input_metadata = disch_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_disch_lateabx_adjGAgroup_PMAsample"), 
    fixed_effects = c("AB_after72h", "extremely_preterm", "PMA_sample_w"))

maaslin_disch_lateabx_adjGAgroup_PMAsample_bar= as.data.frame(maaslin_disch_lateabx_adjGAgroup_PMAsample$results)%>%
              subset(metadata=="AB_after72h") %>%
               arrange(coef)%>%
  mutate(group = if_else(coef<0, "No antibiotics", "Antibiotics >72h"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               filter(qval<0.25) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#E7C382", "#88886A"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Antibiotic exposure >72h")

maaslin_disch_lateabx_adjGAgroup_PMAsample_bar

#-------------------------------------------------
#effect of sex
maaslin_disch_sex_adjGAgroup_PMAsample = Maaslin2(
    input_data = disch_asv, 
    input_metadata = disch_meta, 
    min_prevalence = 0.05,
    min_abundance = 0.01,
    normalization = "NONE",
    output = here("results", "maaslin_results", "maaslin_disch_sex_adjGAgroup_PMAsample"), 
    fixed_effects = c("extremely_preterm", "PMA_sample_w", "sex"))

maaslin_disch_sex_adjGAgroup_PMAsample_bar= as.data.frame(maaslin_disch_sex_adjGAgroup_PMAsample$results)%>%
              subset(metadata=="sex") %>%
               arrange(coef)%>%
               filter(qval<0.25) %>%
               mutate(group = if_else(coef<0, "Male", "Female"),
                      feature_new = format_OTU(feature),
                      feature_new=factor(feature_new, levels = feature_new)) %>%
               ggplot(aes(x=coef,y=feature_new, fill=group))+ 
               geom_bar(stat = "identity" ,width = 0.5)+
   geom_errorbar( aes(y=feature_new, xmin=coef-stderr, xmax=coef+stderr), width=0.05, colour="black", alpha=0.9, size=0.3) +
               scale_fill_manual(values=c("#5179C3", "#D890B1"), name="") +
  theme_bw(base_size=13) +
  theme(axis.text.y = ggtext::element_markdown(size=12)) + 
  scale_x_continuous(labels = scales::number_format(accuracy = 0.1),limits = c(-2.5,2.5)) +
  geom_vline(xintercept = 0, col="black")+
  xlab("Standardised \u03b2 with SE") +ylab("") + ggtitle("Sex")

maaslin_disch_sex_adjGAgroup_PMAsample_bar


#make a joint figure for the baseline models (GAgroup, sex, abx)
baseline_disch <- ggarrange(maaslin_disch_GAgroup_adjPMAsample_bar, maaslin_disch_sex_adjGAgroup_PMAsample_bar, maaslin_disch_lateabx_adjGAgroup_PMAsample_bar, nrow=3, align="v", heights=c(2.2,2,1.2))

baseline_disch

png(file=here("results", "figures", "perinatal_baseline_disch_maaslin.png"), width = 11.1, height =7, units = "in",res=300)
print(baseline_disch)
dev.off()


#----------------------------------------------
#joint maaslin results plot for baseline and fully adjusted
joint_maaslin_disch <- ggarrange(baseline_disch, full_disch, ncol=2, labels=c("A", "B"))

joint_maaslin_disch

png(file=here("results", "figures", "perinatal_baseline_full_disch_maaslin.png"), width = 13, height =7, units = "in",res=300)
print(joint_maaslin_disch)
dev.off()


```

# Mode of delivery barplot
not presented in thesis but just a nice plot

Here I had to create a new variable to have combinations of mode of delivery and timepoint; maybe there is a cleverer way to make it but currently this works.

```{r modedelivery_barplot, ow = "50%"}

#create a new variable for the combination of delivery mode and timepoint
sample_data(phy_preterm) <- sample_data(phy_preterm) %>% data.frame() %>%
  mutate(timepoint_modedelivery = case_when(
    Visit_number == "V1" & Vaginal_delivery == 0 ~ "meconium_csection",
    Visit_number == "V1" & Vaginal_delivery == 1 ~ "meconium_vaginal",
    Visit_number == "V2" & Vaginal_delivery == 0 ~ "discharge_csection",
    Visit_number == "V2" & Vaginal_delivery == 1 ~ "discharge_vaginal"
  )) %>%
  mutate(timepoint_modedelivery = factor(timepoint_modedelivery, levels=c("meconium_vaginal", "discharge_vaginal", "meconium_csection", "discharge_csection")))

# Abundance plots for top 25 OTUs
#using the function I created when doing the clustering
grouped_asv_plot_modedelivery <- grouped_stacked_bar(phy_preterm, n_otus = 25, grouping_var = "timepoint_modedelivery") +
  scale_x_discrete(labels=c("meconium_csection" = "Meconium:\nC-section", "meconium_vaginal" = "Meconium:\nVaginal delivery",
                              "discharge_csection" = "Pre-discharge:\nC-section", "discharge_vaginal" = "Pre-discharge:\nVaginal delivery"))

grouped_asv_plot_modedelivery

png(file=here("results", "figures", "modeofdelivery_grouped_barplot.png"), width = 10.5, height =7, units = "in",res=300)
print(grouped_asv_plot_modedelivery)
dev.off()


```

# GA group barplot for discharge samples
also not presented in thesis; simply for visualisation purposes

```{r GAgroup_barplot, ow = "50%"}

grouped_asv_plot_GAgroup <- grouped_stacked_bar(phy_disch, n_otus = 25, grouping_var = "extremely_preterm") +
  scale_x_discrete(labels=c("X0" = "Very preterm", "X1" = "Extremely preterm"))

grouped_asv_plot_GAgroup

png(file=here("results", "figures", "GAgroup_grouped_barplot.png"), width = 10, height =7, units = "in",res=300)
print(grouped_asv_plot_GAgroup)
dev.off()


#do a boxplot instead: two options to order first by group and then ASVs or the other way around

sample_data(phy_disch) <- sample_data(phy_disch) %>% data.frame() %>%
  rename(sample_id3 = sample_id)

df_disch <- stacked.bar(phy_disch, n_otus=20, hc_order=F, plot=F, by_genus=F)

ggplot(df_disch, aes(x=as.factor(extremely_preterm), y=RA, fill=as.factor(OTU))) +
  geom_point(position = position_dodge(width = 0.7), size=1.3, alpha=0.8, aes(color=as.factor(OTU))) +
  geom_boxplot(outlier.shape = NA, alpha=0.7, position=position_dodge(0.7), width=0.7, color="black", coef = 0) + 
  scale_fill_manual(name="ASV", values=c("grey90", rev(make_color_scheme("Paired", n=20)))) +
  scale_colour_manual(name="ASV", values=c("grey90", rev(make_color_scheme("Paired", n=20)))) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  theme_bw(base_size=12) + theme(legend.text = ggtext::element_markdown()) +
  guides(fill = guide_legend(ncol = 1, reverse = T),
         color = guide_legend(ncol = 1, reverse = T)) +
  scale_x_discrete(labels=c("0" = "Very preterm", "1" = "Extremely preterm")) +
  xlab("GA group") + ylab("Relative abundance (%)")

ggplot(df_disch, aes(x=as.factor(OTU) , y=RA, fill=as.factor(extremely_preterm))) +
  geom_point(position = position_dodge(width = 0.7), size=1.3, alpha=0.8, aes(color=as.factor(extremely_preterm))) +
  geom_boxplot(outlier.shape = NA, alpha=0.7, position=position_dodge(0.7), width=0.7, color="black", coef = 0) + 
  #scale_fill_manual(name="ASV", values=c("grey90", rev(make_color_scheme("Paired", n=20)))) +
  #scale_colour_manual(name="ASV", values=c("grey90", rev(make_color_scheme("Paired", n=20)))) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  theme_bw(base_size=12) + theme(axis.text.x = ggtext::element_markdown(angle = 90)) +
  ylab("Relative abundance (%)") +xlab("ASV")
  #scale_x_discrete(labels=c("0" = "Very preterm", "1" = "Extremely preterm")) +
  #xlab("GA group") + ylab("Relative abundance (%)")


```
